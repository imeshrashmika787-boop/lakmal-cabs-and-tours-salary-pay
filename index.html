<!doctype html>
<html lang="si">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lakmal Cabs & Tours — Admin Dashboard</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:Inter, system-ui, Arial, sans-serif}
body{background:#f4f7fb;color:#0b2447;padding:20px}
.container{max-width:1100px;margin:0 auto}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
header h1{font-size:20px}
.logo{display:flex;align-items:center;gap:10px}
.logo .badge{background:#083d77;color:#fff;padding:8px 12px;border-radius:8px}
.grid{display:grid;grid-template-columns:320px 1fr;gap:18px}
.card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(9,30,66,0.06)}
.sidebar .nav{display:flex;flex-direction:column;gap:10px}
.nav button{padding:10px;border-radius:8px;border:1px solid #e6eef8;background:transparent;cursor:pointer}
.nav button.active{background:#083d77;color:#fff;border-color:transparent}
.top-stats{display:flex;gap:12px;margin-bottom:12px}
.stat{flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#f7fbff);border:1px solid #e9f0fb}
.stat h3{font-size:14px;color:#69798a;margin-bottom:6px}
.stat p{font-size:18px;font-weight:700}
form .row{display:flex;gap:10px;margin-bottom:10px}
label{display:block;font-size:13px;margin-bottom:6px}
input[type=text], input[type=number], select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #d9e6f8}
.btn{display:inline-block;padding:10px 14px;border-radius:8px;border:0;background:#083d77;color:#fff;cursor:pointer}
.btn.secondary{background:#eef4ff;color:#083d77}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:10px;border-bottom:1px solid #eef4fb;text-align:left}
th{background:#fbfdff}
.small{font-size:13px;color:#556676}
.right{display:flex;gap:10px;align-items:center}
.modal{position:fixed;inset:0;background:rgba(3,30,66,0.45);display:flex;align-items:center;justify-content:center}
.modal .card{width:420px}
.hidden{display:none}
@media (max-width:880px){.grid{grid-template-columns:1fr}.sidebar{order:2}}
</style>
</head>
<body>
<div class="container">
<header>
<div class="logo">
<div class="badge">Lakmal Cabs</div>
<div>
<h1>Admin Dashboard</h1>
<div class="small">Manage hires, expenses, drivers & payouts</div>
</div>
</div>
<div class="right">
<div id="currentAdmin" class="small">Not logged in</div>
<button id="logoutBtn" class="btn secondary hidden">Logout</button>
</div>
</header>

<div class="grid">
<aside class="sidebar">
<div class="card">
<div class="small" style="margin-bottom:8px">Admin controls</div>
<div class="nav">
<button id="btnDashboard" class="active">Dashboard</button>
<button id="btnAddHire">Add Hire</button>
<button id="btnDrivers">Drivers</button>
<button id="btnHistory">History</button>
<button id="btnSettings">Settings</button>
</div>
</div>
<div class="card" style="margin-top:12px">
<div class="small">Quick actions</div>
<div style="margin-top:8px;display:flex;gap:8px">
<button id="exportCsv" class="btn secondary">Export CSV</button>
</div>
<div class="small" style="margin-top:10px">* Data is saved in your browser (localStorage).</div>
</div>
</aside>

<main>
<section id="viewDashboard" class="card">
<div class="top-stats">
<div class="stat">
<h3>Total Hires</h3>
<p id="statHires">0</p>
</div>
<div class="stat">
<h3>Today's Payouts</h3>
<p id="statToday">0</p>
</div>
<div class="stat">
<h3>Admin Balance</h3>
<p id="statAdminBal">0</p>
</div>
</div>

<h3>Quick Add Hire</h3>
<form id="quickHireForm">
<div class="row">
<div style="flex:1">
<label>Hire Price (admin hires)</label>
<input id="hire_price" type="number" min="0" step="0.01" required>
</div>
<div style="width:160px">
<label>Driver Salary</label>
<input id="driver_salary" type="number" min="0" step="0.01" required>
</div>
</div>

<div class="row">
<div style="flex:1">
<label>Another Expenses</label>
<input id="another_expenses" type="number" min="0" step="0.01" value="0" required>
</div>
</div>

<div style="display:flex;gap:10px;align-items:center;margin-top:8px">
<button class="btn" type="submit">Add Hire & Calculate</button>
<div class="small">Admin salary = hire_price - (driver_salary + another_expenses)</div>
</div>
</form>

<h3 style="margin-top:14px">Latest Hires</h3>
<div id="latestHires"></div>
</section>

<section id="viewAddHire" class="card hidden">
<h3>Add detailed hire</h3>
<form id="addHireForm">
<label>Customer / Trip Note</label>
<input id="trip_note" type="text" placeholder="eg: Airport to Galle">

<div class="row">
<div style="flex:1">
<label>Hire Price</label>
<input id="hire_price_full" type="number" min="0" step="0.01" required>
</div>
<div style="width:180px">
<label>Driver</label>
<select id="hire_driver"></select>
</div>
</div>

<div class="row">
<div style="flex:1">
<label>Driver Salary</label>
<input id="driver_salary_full" type="number" min="0" step="0.01" required>
</div>
<div style="width:160px">
<label>Another Expenses</label>
<input id="another_expenses_full" type="number" min="0" step="0.01" value="0">
</div>
</div>

<div class="row">
<div style="flex:1">
<label>Date & Time</label>
<input id="hire_datetime_full" type="datetime-local" required>
</div>
<div style="width:120px">
<label>Paid?</label>
<select id="paid_status">
<option value="true">Yes</option>
<option value="false">No</option>
</select>
</div>
</div>

<div style="display:flex;gap:10px;margin-top:10px">
<button class="btn" type="submit">Save Hire</button>
<button id="cancelAddHire" type="button" class="btn secondary">Cancel</button>
</div>
</form>
</section>

<section id="viewDrivers" class="card hidden">
<h3>Drivers</h3>
<form id="driverForm" style="margin-bottom:12px">
<div class="row">
<div style="flex:1">
<label>Driver Name</label>
<input id="driver_name" type="text" required>
</div>
<div style="width:140px">
<label>Phone (optional)</label>
<input id="driver_phone" type="text">
</div>
</div>
<div style="display:flex;gap:8px;margin-top:8px">
<button class="btn">Add Driver</button>
<button id="clearDrivers" type="button" class="btn secondary">Clear Drivers</button>
</div>
</form>

<table id="driversTable">
<thead><tr><th>Name</th><th>Phone</th><th>Action</th></tr></thead>
<tbody></tbody>
</table>
</section>

<section id="viewHistory" class="card hidden">
<h3>Hires History</h3>
<div id="historyList"></div>
</section>

<section id="viewSettings" class="card hidden">
<h3>Settings</h3>
<div class="small">Admin login — default: admin/admin</div>
<div style="margin-top:10px">
<label>Change Admin Username</label>
<input id="settingAdminUser" type="text">
<label style="margin-top:8px">Change Admin Password</label>
<input id="settingAdminPass" type="text">
<div style="margin-top:8px">
<button id="saveSettings" class="btn">Save</button>
</div>
</div>
</section>
</main>
</div>
</div>

<div id="loginModal" class="modal">
<div class="card">
<h2>Admin Login</h2>
<form id="loginForm">
<label>Username</label>
<input id="loginUser" type="text" required>
<label style="margin-top:8px">Password</label>
<input id="loginPass" type="password" required>
<div style="display:flex;gap:8px;margin-top:12px;align-items:center">
<button class="btn" type="submit">Login</button>
<button id="demoFill" type="button" class="btn secondary">Fill demo</button>
</div>
</form>
</div>
</div>

<script>
const LS={admiN:'lakmal_admin',drivers:'lakmal_drivers',hires:'lakmal_hires',session:'lakmal_session'};
const q=sel=>document.querySelector(sel),qAll=sel=>document.querySelectorAll(sel);

function ensureDefaults(){if(!localStorage.getItem(LS.admiN))localStorage.setItem(LS.admiN,JSON.stringify({user:'admin',pass:'admin'}));if(!localStorage.getItem(LS.drivers))localStorage.setItem(LS.drivers,JSON.stringify([]));if(!localStorage.getItem(LS.hires))localStorage.setItem(LS.hires,JSON.stringify([]))}
ensureDefaults();

// ---------- AUTH ----------
const loginModal=q('#loginModal'),currentAdminEl=q('#currentAdmin'),logoutBtn=q('#logoutBtn');
function getAdminCreds(){return JSON.parse(localStorage.getItem(LS.admiN)||'{}')}
function setSession(user){localStorage.setItem(LS.session,JSON.stringify({user,ts:Date.now()}))}
function clearSession(){localStorage.removeItem(LS.session)}
function getSession(){return JSON.parse(localStorage.getItem(LS.session)||'null')}
function requireLogin(){const s=getSession();if(!s)loginModal.classList.remove('hidden');else{loginModal.classList.add('hidden');updateUIForLogin(s.user)}}
document.getElementById('loginForm').addEventListener('submit',e=>{e.preventDefault();const user=q('#loginUser').value.trim();const pass=q('#loginPass').value;const creds=getAdminCreds();if(user===creds.user&&pass===creds.pass){setSession(user);requireLogin()}else alert('Login failed')})
q('#demoFill').addEventListener('click',()=>{q('#loginUser').value='admin';q('#loginPass').value='admin'})
logoutBtn.addEventListener('click',()=>{clearSession();location.reload()})
function updateUIForLogin(user){currentAdminEl.textContent=`Hi, ${user}`;logoutBtn.classList.remove('hidden')}

// ---------- NAV ----------
const views=['viewDashboard','viewAddHire','viewDrivers','viewHistory','viewSettings'];
function showView(id){views.forEach(v=>q('#'+v).classList.add('hidden'));q('#'+id).classList.remove('hidden');qAll('.nav button').forEach(b=>b.classList.remove('active'));if(id==='viewDashboard')q('#btnDashboard').classList.add('active');if(id==='viewAddHire')q('#btnAddHire').classList.add('active');if(id==='viewDrivers')q('#btnDrivers').classList.add('active');if(id==='viewHistory')q('#btnHistory').classList.add('active');if(id==='viewSettings')q('#btnSettings').classList.add('active')}
q('#btnDashboard').addEventListener('click',()=>showView('viewDashboard'))
q('#btnAddHire').addEventListener('click',()=>showView('viewAddHire'))
q('#btnDrivers').addEventListener('click',()=>showView('viewDrivers'))
q('#btnHistory').addEventListener('click',()=>showView('viewHistory'))
q('#btnSettings').addEventListener('click',()=>showView('viewSettings'))

// ---------- DRIVERS ----------
function loadDrivers(){const arr=JSON.parse(localStorage.getItem(LS.drivers)||'[]');const tbody=q('#driversTable tbody');tbody.innerHTML='';const sel=q('#hire_driver');sel.innerHTML='<option value="">(No driver)</option>';arr.forEach((d,i)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${d.name}</td><td>${d.phone||''}</td><td><button data-i='${i}' class='btn secondary delDriver'>Delete</button></td>`;tbody.appendChild(tr);const opt=document.createElement('option');opt.value=d.name;opt.textContent=d.name;sel.appendChild(opt)})}
document.getElementById('driverForm').addEventListener('submit',e=>{e.preventDefault();const name=q('#driver_name').value.trim();const phone=q('#driver_phone').value.trim();if(!name)return alert('Enter driver name');const arr=JSON.parse(localStorage.getItem(LS.drivers)||'[]');arr.push({name,phone});localStorage.setItem(LS.drivers,JSON.stringify(arr));q('#driver_name').value='';q('#driver_phone').value='';loadDrivers()})
q('#driversTable').addEventListener('click',e=>{if(e.target.classList.contains('delDriver')){const i=+e.target.dataset.i;const arr=JSON.parse(localStorage.getItem(LS.drivers)||'[]');arr.splice(i,1);localStorage.setItem(LS.drivers,JSON.stringify(arr));loadDrivers()}})
q('#clearDrivers').addEventListener('click',()=>{if(confirm('Clear all drivers?')){localStorage.setItem(LS.drivers,JSON.stringify([]));loadDrivers()}})

// ---------- HIRES ----------
function calculateAdminSalary(hire_price,driver_salary,another_expenses){return Math.round((Number(hire_price)-(Number(driver_salary)+Number(another_expenses)))*100)/100}
function saveHire(entry){const arr=JSON.parse(localStorage.getItem(LS.hires)||'[]');arr.unshift(entry);localStorage.setItem(LS.hires,JSON.stringify(arr));refreshStats();loadLatest();loadHistory()}
function formatDateTime(dt){const d=new Date(dt);return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')+' '+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')+':'+String(d.getSeconds()).padStart(2,'0')}

// Quick Hire
q('#quickHireForm').addEventListener('submit',e=>{e.preventDefault();const hp=q('#hire_price').value||0;const ds=q('#driver_salary').value||0;const ae=q('#another_expenses').value||0;const dt=formatDateTime(new Date());const adminSalary=calculateAdminSalary(hp,ds,ae);const entry={trip_note:'Quick hire',hire_price:Number(hp),driver_salary:Number(ds),another_expenses:Number(ae),admin_salary:adminSalary,date_time:dt,paid:true};saveHire(entry);alert('Hire added. Admin salary: '+adminSalary);q('#quickHireForm').reset()})

// Detailed Hire
document.getElementById('addHireForm').addEventListener('submit',e=>{e.preventDefault();const trip_note=q('#trip_note').value;const hp=q('#hire_price_full').value||0;const ds=q('#driver_salary_full').value||0;const ae=q('#another_expenses_full').value||0;const dt=q('#hire_datetime_full').value?formatDateTime(q('#hire_datetime_full').value):formatDateTime(new Date());const paid=q('#paid_status').value==='true';const driver=q('#hire_driver').value;const adminSalary=calculateAdminSalary(hp,ds,ae);const entry={trip_note,hire_price:Number(hp),driver_salary:Number(ds),another_expenses:Number(ae),admin_salary:adminSalary,date_time:dt,paid,driver};saveHire(entry);alert('Hire saved — admin: '+adminSalary);q('#addHireForm').reset();showView('viewDashboard')})
q('#cancelAddHire').addEventListener('click',()=>{showView('viewDashboard')})

// Latest Hires
function loadLatest(){const arr=JSON.parse(localStorage.getItem(LS.hires)||'[]');const wrap=q('#latestHires');wrap.innerHTML='';arr.slice(0,6).forEach(h=>{const el=document.createElement('div');el.style.padding='8px';el.style.borderBottom='1px solid #eef4fb';el.innerHTML=`<div style='display:flex;justify-content:space-between'><div><strong>${h.trip_note||'Trip'}</strong><div class='small'>${h.date_time} • ${h.driver||''}</div></div><div style='text-align:right'><div>Hire ${h.hire_price}</div><div class='small'>Admin ${h.admin_salary}</div></div></div>`;wrap.appendChild(el)})}

// History
function loadHistory(){const arr=JSON.parse(localStorage.getItem(LS.hires)||'[]');const wrap=q('#historyList');wrap.innerHTML='';if(arr.length===0){wrap.innerHTML='<div class="small">No hires yet</div>';return}const table=document.createElement('table');table.innerHTML=`<thead><tr><th>Date & Time</th><th>Trip</th><th>Driver</th><th>Hire</th><th>Driver Salary</th><th>Expenses</th><th>Admin</th><th>Action</th></tr></thead>`;const tbody=document.createElement('tbody');arr.forEach((h,i)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${h.date_time}</td><td>${h.trip_note||''}</td><td>${h.driver||''}</td><td>${h.hire_price}</td><td>${h.driver_salary}</td><td>${h.another_expenses}</td><td>${h.admin_salary}</td><td><button data-i='${i}' class='btn secondary delHire'>Delete</button></td>`;tbody.appendChild(tr)});table.appendChild(tbody);wrap.appendChild(table)}
q('#historyList').addEventListener('click',e=>{if(e.target.classList.contains('delHire')){const i=+e.target.dataset.i;const arr=JSON.parse(localStorage.getItem(LS.hires)||'[]');arr.splice(i,1);localStorage.setItem(LS.hires,JSON.stringify(arr));loadLatest();loadHistory();refreshStats()}})

// Stats
function refreshStats(){const hires=JSON.parse(localStorage.getItem(LS.hires)||'[]');q('#statHires').textContent=hires.length;const today=new Date().toISOString().slice(0,10);const todayArr=hires.filter(h=>h.date_time.startsWith(today));const todaySum=todayArr.reduce((s,h)=>s+Number(h.driver_salary||0),0);q('#statToday').textContent=Math.round(todaySum*100)/100;const adminBal=hires.reduce((s,h)=>s+Number(h.admin_salary||0),0);q('#statAdminBal').textContent=Math.round(adminBal*100)/100}

// Export
q('#exportCsv').addEventListener('click',()=>{const hires=JSON.parse(localStorage.getItem(LS.hires)||'[]');if(!hires.length)return alert('No hires to export');const header=['date_time,trip_note,driver,hire_price,driver_salary,another_expenses,admin_salary'];const rows=hires.map(h=>`${h.date_time},"${(h.trip_note||'').replace(/"/g,'""')}",${h.driver||''},${h.hire_price},${h.driver_salary},${h.another_expenses},${h.admin_salary}`);const csv=header.concat(rows).join('\n');const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='lakmal_hires.csv';a.click();URL.revokeObjectURL(url)})

// Settings
q('#saveSettings').addEventListener('click',()=>{const u=q('#settingAdminUser').value.trim();const p=q('#settingAdminPass').value;if(!u||!p)return alert('Enter username & password');localStorage.setItem(LS.admiN,JSON.stringify({user:u,pass:p}));alert('Admin credentials updated. You must login again.');clearSession();requireLogin()})

// Init
function init(){requireLogin();loadDrivers();loadLatest();loadHistory();refreshStats();const now=new Date().toISOString().slice(0,16);q('#hire_datetime_full').value=now}
init()
</script>
</body>
</html>

